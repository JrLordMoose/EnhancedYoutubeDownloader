<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:EnhancedYoutubeDownloader.ViewModels"
        xmlns:components="using:EnhancedYoutubeDownloader.ViewModels.Components"
        xmlns:controls="using:EnhancedYoutubeDownloader.Controls"
        xmlns:converters="using:EnhancedYoutubeDownloader.Converters"
        xmlns:asyncImageLoader="clr-namespace:AsyncImageLoader;assembly=AsyncImageLoader.Avalonia"
        xmlns:models="using:EnhancedYoutubeDownloader.Shared.Models"
        xmlns:dialogHostAvalonia="clr-namespace:DialogHostAvalonia;assembly=DialogHost.Avalonia"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
        x:Class="EnhancedYoutubeDownloader.Views.MainView"
        x:DataType="vm:MainViewModel"
        Title="{Binding Title}"
        Icon="/favicon.ico"
        MinWidth="800" MinHeight="600">

    <Window.Resources>
        <converters:PlatformToIconConverter x:Key="PlatformToIconConverter"/>
    </Window.Resources>

    <Design.DataContext>
        <vm:MainViewModel />
    </Design.DataContext>

    <dialogHostAvalonia:DialogHost Identifier="RootDialog">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="{DynamicResource MaterialPaperBrush}"
                BorderBrush="{DynamicResource MaterialDividerBrush}"
                BorderThickness="0,0,0,1">
            <Grid Margin="16,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                          Text="Enhanced Video Downloader"
                          FontSize="24"
                          FontWeight="SemiBold"
                          VerticalAlignment="Center"/>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Content="Tutorial"
                            Classes="Outline"
                            Command="{Binding Dashboard.ShowTutorialCommand}"/>
                    <Button Content="Settings"
                            Classes="Outline"
                            Command="{Binding Dashboard.ShowSettingsCommand}"/>
                    <Button Content="Auth"
                            Classes="Outline"
                            Command="{Binding Dashboard.ShowAuthSetupCommand}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Query Input -->
            <Border Grid.Row="0"
                    Background="{DynamicResource MaterialPaperBrush}"
                    BorderBrush="{DynamicResource MaterialDividerBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="16,12">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBox Grid.Column="0"
                                 x:Name="QueryTextBox"
                                 Text="{Binding Dashboard.Query}"
                                 Watermark="Enter video URL (YouTube, TikTok, Instagram, Twitter) or search query..."
                                 Classes="Outline"
                                 Margin="0,0,8,0"
                                 KeyDown="OnQueryTextBoxKeyDown"/>

                        <Button Grid.Column="1"
                                Content="Download"
                                Classes="Flat"
                                Command="{Binding Dashboard.ProcessQueryCommand}"
                                IsEnabled="{Binding Dashboard.ProcessQueryCommand.CanExecute}"/>
                    </Grid>

                    <!-- Error Message -->
                    <TextBlock Grid.Row="1"
                               Text="{Binding Dashboard.QueryError}"
                               IsVisible="{Binding Dashboard.QueryError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                               Foreground="#F44336"
                               FontSize="12"
                               Margin="0,4,0,0"/>
                </Grid>
            </Border>

            <!-- Downloads List -->
            <Grid Grid.Row="1">
                <ScrollViewer Padding="16"
                             VerticalScrollBarVisibility="Auto"
                             HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding Dashboard.Downloads}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="models:DownloadItem">
                                <Border Background="{DynamicResource MaterialCardBackgroundBrush}"
                                        BorderBrush="{DynamicResource MaterialDividerBrush}"
                                        BorderThickness="1"
                                        CornerRadius="8"
                                        Margin="0,0,0,12"
                                        Padding="16">
                                    <Grid RowDefinitions="Auto,Auto,Auto">

                                        <!-- Row 0: Thumbnail, Title, Author -->
                                        <Grid Grid.Row="0" ColumnDefinitions="100,*">
                                            <!-- Thumbnail -->
                                            <Border Grid.Column="0"
                                                    Width="100"
                                                    Height="75"
                                                    CornerRadius="6"
                                                    ClipToBounds="True"
                                                    Margin="0,0,12,0"
                                                    Background="{DynamicResource MaterialDividerBrush}">
                                                <Panel>
                                                    <!-- Thumbnail Image -->
                                                    <Image asyncImageLoader:ImageLoader.Source="{Binding ThumbnailUrl}"
                                                           Stretch="UniformToFill"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                                    <!-- Fallback - Platform Icon -->
                                                    <TextBlock FontSize="32"
                                                              Opacity="0.4"
                                                              HorizontalAlignment="Center"
                                                              VerticalAlignment="Center"
                                                              IsVisible="{Binding ThumbnailUrl, Converter={x:Static StringConverters.IsNullOrEmpty}}">
                                                        <TextBlock.Text>
                                                            <MultiBinding Converter="{StaticResource PlatformToIconConverter}">
                                                                <Binding Path="Platform"/>
                                                            </MultiBinding>
                                                        </TextBlock.Text>
                                                    </TextBlock>
                                                </Panel>
                                            </Border>

                                            <!-- Title and Author -->
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="4">
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <TextBlock Text="{Binding Title}"
                                                              FontSize="15"
                                                              FontWeight="SemiBold"
                                                              TextWrapping="Wrap"
                                                              MaxLines="2"/>
                                                    <Border Background="#F9A825"
                                                            CornerRadius="4"
                                                            Padding="6,2"
                                                            VerticalAlignment="Top"
                                                            Margin="0,2,0,0">
                                                        <TextBlock Text="{Binding PlatformDisplayName}"
                                                                  FontSize="10"
                                                                  FontWeight="SemiBold"
                                                                  Foreground="#FFFFFF"/>
                                                    </Border>
                                                </StackPanel>
                                                <TextBlock Text="{Binding Author}"
                                                          FontSize="13"
                                                          Opacity="0.65"
                                                          TextWrapping="NoWrap"
                                                          TextTrimming="CharacterEllipsis"/>
                                            </StackPanel>
                                        </Grid>

                                        <!-- Row 1: Progress Bar and Info -->
                                        <Grid Grid.Row="1" Margin="0,12,0,0">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <ProgressBar Grid.Row="0"
                                                        Value="{Binding Progress}"
                                                        Maximum="100"
                                                        Height="6"
                                                        CornerRadius="3"/>

                                            <TextBlock Grid.Row="1"
                                                      Text="{Binding FormattedProgressInfo}"
                                                      FontSize="12"
                                                      Opacity="0.6"
                                                      Margin="0,6,0,0"/>
                                        </Grid>

                                        <!-- Row 2: Action Buttons -->
                                        <Border Grid.Row="2"
                                                Margin="0,12,0,0"
                                                Padding="0">
                                            <StackPanel Orientation="Horizontal"
                                                       Spacing="8"
                                                       HorizontalAlignment="Right">
                                                <!-- Start Button (for queued downloads) -->
                                                <Button Content="Start"
                                                        Classes="Outline"
                                                        MinWidth="80"
                                                        Command="{Binding $parent[ItemsControl].DataContext.Dashboard.StartDownloadCommand}"
                                                        CommandParameter="{Binding}"
                                                        IsVisible="{Binding CanStart}"/>
                                                <!-- Resume Button (for paused downloads) -->
                                                <Button Content="Resume"
                                                        Classes="Outline"
                                                        MinWidth="80"
                                                        Command="{Binding $parent[ItemsControl].DataContext.Dashboard.ResumeDownloadCommand}"
                                                        CommandParameter="{Binding}"
                                                        IsVisible="{Binding CanResume}"/>
                                                <!-- Pause Button -->
                                                <Button Content="Pause"
                                                        Classes="Outline"
                                                        MinWidth="80"
                                                        Command="{Binding $parent[ItemsControl].DataContext.Dashboard.PauseDownloadCommand}"
                                                        CommandParameter="{Binding}"
                                                        IsVisible="{Binding CanPause}"/>
                                                <!-- Cancel Button -->
                                                <Button Content="Cancel"
                                                        Classes="Outline"
                                                        MinWidth="80"
                                                        Command="{Binding $parent[ItemsControl].DataContext.Dashboard.CancelDownloadCommand}"
                                                        CommandParameter="{Binding}"
                                                        IsVisible="{Binding CanCancel}"/>
                                                <!-- Open Button -->
                                                <Button Content="Open"
                                                        Classes="Outline"
                                                        MinWidth="80"
                                                        Command="{Binding $parent[ItemsControl].DataContext.Dashboard.OpenDownloadFolderCommand}"
                                                        CommandParameter="{Binding}"
                                                        IsVisible="{Binding CanOpen}"/>
                                                <!-- Restart Button -->
                                                <Button Content="Restart"
                                                        Classes="Outline"
                                                        MinWidth="80"
                                                        Command="{Binding $parent[ItemsControl].DataContext.Dashboard.RestartDownloadCommand}"
                                                        CommandParameter="{Binding}"
                                                        IsVisible="{Binding CanRestart}"/>
                                                <!-- Delete Button -->
                                                <Button Content="Delete"
                                                        Classes="Outline"
                                                        MinWidth="80"
                                                        Command="{Binding $parent[ItemsControl].DataContext.Dashboard.DeleteDownloadCommand}"
                                                        CommandParameter="{Binding}"/>
                                            </StackPanel>
                                        </Border>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Loading Indicator Overlay -->
                <controls:LoadingIndicator IsLoading="{Binding Dashboard.IsBusy}"
                                          LoadingMessage="Resolving query..."
                                          LoadingSubtext="Please wait while we fetch video information"/>
            </Grid>
        </Grid>

        <!-- Snackbar Host (Bottom Center) -->
        <controls:SnackbarHost Grid.Row="0"
                              Grid.RowSpan="2"
                              DataContext="{Binding SnackbarManager}"
                              VerticalAlignment="Bottom"
                              HorizontalAlignment="Stretch"
                              IsHitTestVisible="False"/>
    </Grid>
    </dialogHostAvalonia:DialogHost>
</Window>